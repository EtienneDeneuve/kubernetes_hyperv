- hosts: kube
  become: yes
  pre_tasks:
    - name: set timezone to Asia/Tokyo
      timezone:
        name: Europe/Paris

    - name: install ntpdate
      apt:
        name: ['ntpdate']
        update_cache: no
        state: present
      become: yes

    - name: force time sync
      shell: ntpdate time.windows.com
      become: yes
      tags:
        - skip_ansible_lint

    - name: change the hostname to ensure uniqueness in cluster
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Disable swap
      shell: swapoff -a
      tags:
        - skip_ansible_lint

    - name: Disable swapoff permanently
      replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
        replace: '#\1\2\3swap\4'
        backup: yes
      become: yes

  tasks:
    - name: Add Apt signing key for Kubernetes repo from Google
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present
      become: True
    - name: Add Apt signing key for docker repo
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      become: True
    - name: Add an Apt repository for docker
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable
        state: present
        filename: docker
      become: True
    - name: Add an Apt repository for kubernetes
      apt_repository:
        repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
        state: present
        filename: kubernetes
    - name: Install prerequisites
      apt:
        name: ['apt-transport-https', 'curl', 'software-properties-common', 'ca-certificates']
        state: present
      become: yes
    - name: Install stuff
      apt:
        name: ['kubelet', 'kubeadm', 'kubectl', 'docker-ce']
        state: present
        update_cache: yes
      become: True
