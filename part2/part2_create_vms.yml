- hosts: hyperv
  tasks:

    - name: "Adding xHyperV module using DSC"
      win_psmodule:
        name: xHyper-V
        state: present
      become: True

    - name: "create folders"
      win_file:
        path: "C:\\Kubernetes\\{{ item }}"
        state: directory
      with_items:
        - master
        - worker01
        - worker02

    - name: "Check if image exists"
      stat:
        path: "c:\\Kubernetes\\{{ item }}\\{{ item }}.vhdx"
      register: stat_image
      with_items:
        - master
        - worker01
        - worker02
      
    - name: "copy vhd in folders"
      win_copy:
        src: "C:\\Users\\Administrator\\Documents\\git\\webcast\\part1\\packer\\output-hyperv-iso\\Virtual Hard Disks\\ubuntu-bionic.vhdx"
        dest: "c:\\Kubernetes\\{{ item }}\\{{ item }}.vhdx"
        remote_src: yes
        force: no
      with_items:
        - master
        - worker01
        - worker02

    - name: "Launch dsc configuration script"
      win_shell: C:\Users\Administrator\Documents\git\webcast\part2\dsc\config_vm.ps1
      become: true
    
    - name: "Retrieving IP of each vm"
      win_shell: Get-VMNetworkAdapter -VMName * | ConvertTo-Json
      register: vms
      become: true
    
    - set_fact:
        jsonvms: "{{ vms.stdout | from_json }}"
    
    - name: "Grab ipv4 only"
      set_fact:
        vmiplist: "{{ jsonvms | json_query(filter) }}"
      vars:
        filter: >-
          [].IPAddresses
    
    - name: "Debug"
      debug:
        msg: "{{ item[0] }}"
      with_items:
        - "{{ vmiplist }}"
    
    - name: "Add Host to inventory"
      add_host:
        name: "k8s_master"
        groups: kube,master
        ansible_host: "{{ vmiplist[0][0] }}"
        ansible_user: vagrant
        ansible_password: vagrant
        ansible_become_user: vagrant
        ansible_become_pass: vagrant
      delegate_to: localhost

    - name: "Add Host to inventory"
      add_host:
        name: "k8s_node1"
        groups: kube,node
        ansible_host: "{{ vmiplist[1][0] }}"
        ansible_user: vagrant
        ansible_password: vagrant
        ansible_become_user: vagrant
        ansible_become_pass: vagrant
      delegate_to: localhost

    - name: "Add Host to inventory"
      add_host:
        name: "k8s_node2"
        groups: kube,node
        ansible_host: "{{ vmiplist[2][0] }}"
        ansible_user: vagrant
        ansible_password: vagrant
        ansible_become_user: vagrant
        ansible_become_pass: vagrant
      delegate_to: localhost

    - name: "export inventory"
      shell: ansible-inventory --list